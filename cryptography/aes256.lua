local sbox = {[0]=99,[1]=124,[2]=119,[3]=123,[4]=242,[5]=107,[6]=111,[7]=197,[8]=48,[9]=1,[10]=103,[11]=43,[12]=254,[13]=215,[14]=171,[15]=118,[16]=202,[17]=130,[18]=201,[19]=125,[20]=250,[21]=89,[22]=71,[23]=240,[24]=173,[25]=212,[26]=162,[27]=175,[28]=156,[29]=164,[30]=114,[31]=192,[32]=183,[33]=253,[34]=147,[35]=38,[36]=54,[37]=63,[38]=247,[39]=204,[40]=52,[41]=165,[42]=229,[43]=241,[44]=113,[45]=216,[46]=49,[47]=21,[48]=4,[49]=199,[50]=35,[51]=195,[52]=24,[53]=150,[54]=5,[55]=154,[56]=7,[57]=18,[58]=128,[59]=226,[60]=235,[61]=39,[62]=178,[63]=117,[64]=9,[65]=131,[66]=44,[67]=26,[68]=27,[69]=110,[70]=90,[71]=160,[72]=82,[73]=59,[74]=214,[75]=179,[76]=41,[77]=227,[78]=47,[79]=132,[80]=83,[81]=209,[82]=0,[83]=237,[84]=32,[85]=252,[86]=177,[87]=91,[88]=106,[89]=203,[90]=190,[91]=57,[92]=74,[93]=76,[94]=88,[95]=207,[96]=208,[97]=239,[98]=170,[99]=251,[100]=67,[101]=77,[102]=51,[103]=133,[104]=69,[105]=249,[106]=2,[107]=127,[108]=80,[109]=60,[110]=159,[111]=168,[112]=81,[113]=163,[114]=64,[115]=143,[116]=146,[117]=157,[118]=56,[119]=245,[120]=188,[121]=182,[122]=218,[123]=33,[124]=16,[125]=255,[126]=243,[127]=210,[128]=205,[129]=12,[130]=19,[131]=236,[132]=95,[133]=151,[134]=68,[135]=23,[136]=196,[137]=167,[138]=126,[139]=61,[140]=100,[141]=93,[142]=25,[143]=115,[144]=96,[145]=129,[146]=79,[147]=220,[148]=34,[149]=42,[150]=144,[151]=136,[152]=70,[153]=238,[154]=184,[155]=20,[156]=222,[157]=94,[158]=11,[159]=219,[160]=224,[161]=50,[162]=58,[163]=10,[164]=73,[165]=6,[166]=36,[167]=92,[168]=194,[169]=211,[170]=172,[171]=98,[172]=145,[173]=149,[174]=228,[175]=121,[176]=231,[177]=200,[178]=55,[179]=109,[180]=141,[181]=213,[182]=78,[183]=169,[184]=108,[185]=86,[186]=244,[187]=234,[188]=101,[189]=122,[190]=174,[191]=8,[192]=186,[193]=120,[194]=37,[195]=46,[196]=28,[197]=166,[198]=180,[199]=198,[200]=232,[201]=221,[202]=116,[203]=31,[204]=75,[205]=189,[206]=139,[207]=138,[208]=112,[209]=62,[210]=181,[211]=102,[212]=72,[213]=3,[214]=246,[215]=14,[216]=97,[217]=53,[218]=87,[219]=185,[220]=134,[221]=193,[222]=29,[223]=158,[224]=225,[225]=248,[226]=152,[227]=17,[228]=105,[229]=217,[230]=142,[231]=148,[232]=155,[233]=30,[234]=135,[235]=233,[236]=206,[237]=85,[238]=40,[239]=223,[240]=140,[241]=161,[242]=137,[243]=13,[244]=191,[245]=230,[246]=66,[247]=104,[248]=65,[249]=153,[250]=45,[251]=15,[252]=176,[253]=84,[254]=187,[255]=22}
local invsbox = {[99]=0,[124]=1,[119]=2,[123]=3,[242]=4,[107]=5,[111]=6,[197]=7,[48]=8,[1]=9,[103]=10,[43]=11,[254]=12,[215]=13,[171]=14,[118]=15,[202]=16,[130]=17,[201]=18,[125]=19,[250]=20,[89]=21,[71]=22,[240]=23,[173]=24,[212]=25,[162]=26,[175]=27,[156]=28,[164]=29,[114]=30,[192]=31,[183]=32,[253]=33,[147]=34,[38]=35,[54]=36,[63]=37,[247]=38,[204]=39,[52]=40,[165]=41,[229]=42,[241]=43,[113]=44,[216]=45,[49]=46,[21]=47,[4]=48,[199]=49,[35]=50,[195]=51,[24]=52,[150]=53,[5]=54,[154]=55,[7]=56,[18]=57,[128]=58,[226]=59,[235]=60,[39]=61,[178]=62,[117]=63,[9]=64,[131]=65,[44]=66,[26]=67,[27]=68,[110]=69,[90]=70,[160]=71,[82]=72,[59]=73,[214]=74,[179]=75,[41]=76,[227]=77,[47]=78,[132]=79,[83]=80,[209]=81,[0]=82,[237]=83,[32]=84,[252]=85,[177]=86,[91]=87,[106]=88,[203]=89,[190]=90,[57]=91,[74]=92,[76]=93,[88]=94,[207]=95,[208]=96,[239]=97,[170]=98,[251]=99,[67]=100,[77]=101,[51]=102,[133]=103,[69]=104,[249]=105,[2]=106,[127]=107,[80]=108,[60]=109,[159]=110,[168]=111,[81]=112,[163]=113,[64]=114,[143]=115,[146]=116,[157]=117,[56]=118,[245]=119,[188]=120,[182]=121,[218]=122,[33]=123,[16]=124,[255]=125,[243]=126,[210]=127,[205]=128,[12]=129,[19]=130,[236]=131,[95]=132,[151]=133,[68]=134,[23]=135,[196]=136,[167]=137,[126]=138,[61]=139,[100]=140,[93]=141,[25]=142,[115]=143,[96]=144,[129]=145,[79]=146,[220]=147,[34]=148,[42]=149,[144]=150,[136]=151,[70]=152,[238]=153,[184]=154,[20]=155,[222]=156,[94]=157,[11]=158,[219]=159,[224]=160,[50]=161,[58]=162,[10]=163,[73]=164,[6]=165,[36]=166,[92]=167,[194]=168,[211]=169,[172]=170,[98]=171,[145]=172,[149]=173,[228]=174,[121]=175,[231]=176,[200]=177,[55]=178,[109]=179,[141]=180,[213]=181,[78]=182,[169]=183,[108]=184,[86]=185,[244]=186,[234]=187,[101]=188,[122]=189,[174]=190,[8]=191,[186]=192,[120]=193,[37]=194,[46]=195,[28]=196,[166]=197,[180]=198,[198]=199,[232]=200,[221]=201,[116]=202,[31]=203,[75]=204,[189]=205,[139]=206,[138]=207,[112]=208,[62]=209,[181]=210,[102]=211,[72]=212,[3]=213,[246]=214,[14]=215,[97]=216,[53]=217,[87]=218,[185]=219,[134]=220,[193]=221,[29]=222,[158]=223,[225]=224,[248]=225,[152]=226,[17]=227,[105]=228,[217]=229,[142]=230,[148]=231,[155]=232,[30]=233,[135]=234,[233]=235,[206]=236,[85]=237,[40]=238,[223]=239,[140]=240,[161]=241,[137]=242,[13]=243,[191]=244,[230]=245,[66]=246,[104]=247,[65]=248,[153]=249,[45]=250,[15]=251,[176]=252,[84]=253,[187]=254,[22]=255}
local rcon = {1, 2, 4, 8, 16, 32, 64}

local bit = _G.bit or _G.bit32

if not bit then
    local status, tbl = pcall(require, "bit")
    if status then bit = tbl end

    local status, tbl = pcall(require, "bit32")
    if status then bit = tbl end
end

if not bit then error("bit library not found!") end

local char = string.char
local bxor = bit.bxor
local band = bit.band
local rshift = bit.rshift
local lshift = bit.lshift

local function gf(a, b)
    local p = 0
    for i = 0, 8 do
        if band(b, 1) == 1 then p = bxor(p, a) end
        local t = band(a, 0x80)
        a = band(lshift(a, 1), 255)
        if t == 0x80 then a = bxor(a, 0x1b) end
        b = rshift(b, 1)
    end
    return p
end

local function expandkey(key)
    local _ = {
        key:sub(1,1):byte(), key:sub(2,2):byte(), key:sub(3,3):byte(), key:sub(4,4):byte(), key:sub(5,5):byte(), key:sub(6,6):byte(), key:sub(7,7):byte(), key:sub(8,8):byte(),
        key:sub(9,9):byte(), key:sub(10,10):byte(), key:sub(11,11):byte(), key:sub(12,12):byte(), key:sub(13,13):byte(), key:sub(14,14):byte(), key:sub(15,15):byte(), key:sub(16,16):byte(),
        key:sub(17,17):byte(), key:sub(18,18):byte(), key:sub(19,19):byte(), key:sub(20,20):byte(), key:sub(21,21):byte(), key:sub(22,22):byte(), key:sub(23,23):byte(), key:sub(24,24):byte(),
        key:sub(25,25):byte(), key:sub(26,26):byte(), key:sub(27,27):byte(), key:sub(28,28):byte(), key:sub(29,29):byte(), key:sub(30,30):byte(), key:sub(31,31):byte(), key:sub(32,32):byte(),
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    }
    _[33], _[34], _[35], _[36] = bxor(_[1], bxor(sbox[_[30]], 1)), bxor(_[2], sbox[_[31]]), bxor(_[3], sbox[_[32]]), bxor(_[4], sbox[_[29]])
    _[37], _[38], _[39], _[40] = bxor(_[5], _[33]), bxor(_[6], _[34]), bxor(_[7], _[35]), bxor(_[8], _[36])
    _[41], _[42], _[43], _[44] = bxor(_[9], _[37]), bxor(_[10], _[38]), bxor(_[11], _[39]), bxor(_[12], _[40])
    _[45], _[46], _[47], _[48] = bxor(_[13], _[41]), bxor(_[14], _[42]), bxor(_[15], _[43]), bxor(_[16], _[44])
    _[49], _[50], _[51], _[52] = bxor(_[17], sbox[_[45]]), bxor(_[18], sbox[_[46]]), bxor(_[19], sbox[_[47]]), bxor(_[20], sbox[_[48]])
    _[53], _[54], _[55], _[56] = bxor(_[21], _[49]), bxor(_[22], _[50]), bxor(_[23], _[51]), bxor(_[24], _[52])
    _[57], _[58], _[59], _[60] = bxor(_[25], _[53]), bxor(_[26], _[54]), bxor(_[27], _[55]), bxor(_[28], _[56])
    _[61], _[62], _[63], _[64] = bxor(_[29], _[57]), bxor(_[30], _[58]), bxor(_[31], _[59]), bxor(_[32], _[60])
    _[65], _[66], _[67], _[68] = bxor(_[33], bxor(sbox[_[62]], 2)), bxor(_[34], sbox[_[63]]), bxor(_[35], sbox[_[64]]), bxor(_[36], sbox[_[61]])
    _[69], _[70], _[71], _[72] = bxor(_[37], _[65]), bxor(_[38], _[66]), bxor(_[39], _[67]), bxor(_[40], _[68])
    _[73], _[74], _[75], _[76] = bxor(_[41], _[69]), bxor(_[42], _[70]), bxor(_[43], _[71]), bxor(_[44], _[72])
    _[77], _[78], _[79], _[80] = bxor(_[45], _[73]), bxor(_[46], _[74]), bxor(_[47], _[75]), bxor(_[48], _[76])
    _[81], _[82], _[83], _[84] = bxor(_[49], sbox[_[77]]), bxor(_[50], sbox[_[78]]), bxor(_[51], sbox[_[79]]), bxor(_[52], sbox[_[80]])
    _[85], _[86], _[87], _[88] = bxor(_[53], _[81]), bxor(_[54], _[82]), bxor(_[55], _[83]), bxor(_[56], _[84])
    _[89], _[90], _[91], _[92] = bxor(_[57], _[85]), bxor(_[58], _[86]), bxor(_[59], _[87]), bxor(_[60], _[88])
    _[93], _[94], _[95], _[96] = bxor(_[61], _[89]), bxor(_[62], _[90]), bxor(_[63], _[91]), bxor(_[64], _[92])
    _[97], _[98], _[99], _[100] = bxor(_[65], bxor(sbox[_[94]], 4)), bxor(_[66], sbox[_[95]]), bxor(_[67], sbox[_[96]]), bxor(_[68], sbox[_[93]])
    _[101], _[102], _[103], _[104] = bxor(_[69], _[97]), bxor(_[70], _[98]), bxor(_[71], _[99]), bxor(_[72], _[100])
    _[105], _[106], _[107], _[108] = bxor(_[73], _[101]), bxor(_[74], _[102]), bxor(_[75], _[103]), bxor(_[76], _[104])
    _[109], _[110], _[111], _[112] = bxor(_[77], _[105]), bxor(_[78], _[106]), bxor(_[79], _[107]), bxor(_[80], _[108])
    _[113], _[114], _[115], _[116] = bxor(_[81], sbox[_[109]]), bxor(_[82], sbox[_[110]]), bxor(_[83], sbox[_[111]]), bxor(_[84], sbox[_[112]])
    _[117], _[118], _[119], _[120] = bxor(_[85], _[113]), bxor(_[86], _[114]), bxor(_[87], _[115]), bxor(_[88], _[116])
    _[121], _[122], _[123], _[124] = bxor(_[89], _[117]), bxor(_[90], _[118]), bxor(_[91], _[119]), bxor(_[92], _[120])
    _[125], _[126], _[127], _[128] = bxor(_[93], _[121]), bxor(_[94], _[122]), bxor(_[95], _[123]), bxor(_[96], _[124])
    _[129], _[130], _[131], _[132] = bxor(_[97], bxor(sbox[_[126]], 8)), bxor(_[98], sbox[_[127]]), bxor(_[99], sbox[_[128]]), bxor(_[100], sbox[_[125]])
    _[133], _[134], _[135], _[136] = bxor(_[101], _[129]), bxor(_[102], _[130]), bxor(_[103], _[131]), bxor(_[104], _[132])
    _[137], _[138], _[139], _[140] = bxor(_[105], _[133]), bxor(_[106], _[134]), bxor(_[107], _[135]), bxor(_[108], _[136])
    _[141], _[142], _[143], _[144] = bxor(_[109], _[137]), bxor(_[110], _[138]), bxor(_[111], _[139]), bxor(_[112], _[140])
    _[145], _[146], _[147], _[148] = bxor(_[113], sbox[_[141]]), bxor(_[114], sbox[_[142]]), bxor(_[115], sbox[_[143]]), bxor(_[116], sbox[_[144]])
    _[149], _[150], _[151], _[152] = bxor(_[117], _[145]), bxor(_[118], _[146]), bxor(_[119], _[147]), bxor(_[120], _[148])
    _[153], _[154], _[155], _[156] = bxor(_[121], _[149]), bxor(_[122], _[150]), bxor(_[123], _[151]), bxor(_[124], _[152])
    _[157], _[158], _[159], _[160] = bxor(_[125], _[153]), bxor(_[126], _[154]), bxor(_[127], _[155]), bxor(_[128], _[156])
    _[161], _[162], _[163], _[164] = bxor(_[129], bxor(sbox[_[158]], 16)), bxor(_[130], sbox[_[159]]), bxor(_[131], sbox[_[160]]), bxor(_[132], sbox[_[157]])
    _[165], _[166], _[167], _[168] = bxor(_[133], _[161]), bxor(_[134], _[162]), bxor(_[135], _[163]), bxor(_[136], _[164])
    _[169], _[170], _[171], _[172] = bxor(_[137], _[165]), bxor(_[138], _[166]), bxor(_[139], _[167]), bxor(_[140], _[168])
    _[173], _[174], _[175], _[176] = bxor(_[141], _[169]), bxor(_[142], _[170]), bxor(_[143], _[171]), bxor(_[144], _[172])
    _[177], _[178], _[179], _[180] = bxor(_[145], sbox[_[173]]), bxor(_[146], sbox[_[174]]), bxor(_[147], sbox[_[175]]), bxor(_[148], sbox[_[176]])
    _[181], _[182], _[183], _[184] = bxor(_[149], _[177]), bxor(_[150], _[178]), bxor(_[151], _[179]), bxor(_[152], _[180])
    _[185], _[186], _[187], _[188] = bxor(_[153], _[181]), bxor(_[154], _[182]), bxor(_[155], _[183]), bxor(_[156], _[184])
    _[189], _[190], _[191], _[192] = bxor(_[157], _[185]), bxor(_[158], _[186]), bxor(_[159], _[187]), bxor(_[160], _[188])
    _[193], _[194], _[195], _[196] = bxor(_[161], bxor(sbox[_[190]], 32)), bxor(_[162], sbox[_[191]]), bxor(_[163], sbox[_[192]]), bxor(_[164], sbox[_[189]])
    _[197], _[198], _[199], _[200] = bxor(_[165], _[193]), bxor(_[166], _[194]), bxor(_[167], _[195]), bxor(_[168], _[196])
    _[201], _[202], _[203], _[204] = bxor(_[169], _[197]), bxor(_[170], _[198]), bxor(_[171], _[199]), bxor(_[172], _[200])
    _[205], _[206], _[207], _[208] = bxor(_[173], _[201]), bxor(_[174], _[202]), bxor(_[175], _[203]), bxor(_[176], _[204])
    _[209], _[210], _[211], _[212] = bxor(_[177], sbox[_[205]]), bxor(_[178], sbox[_[206]]), bxor(_[179], sbox[_[207]]), bxor(_[180], sbox[_[208]])
    _[213], _[214], _[215], _[216] = bxor(_[181], _[209]), bxor(_[182], _[210]), bxor(_[183], _[211]), bxor(_[184], _[212])
    _[217], _[218], _[219], _[220] = bxor(_[185], _[213]), bxor(_[186], _[214]), bxor(_[187], _[215]), bxor(_[188], _[216])
    _[221], _[222], _[223], _[224] = bxor(_[189], _[217]), bxor(_[190], _[218]), bxor(_[191], _[219]), bxor(_[192], _[220])
    _[225], _[226], _[227], _[228] = bxor(_[193], bxor(sbox[_[222]], 64)), bxor(_[194], sbox[_[223]]), bxor(_[195], sbox[_[224]]), bxor(_[196], sbox[_[221]])
    _[229], _[230], _[231], _[232] = bxor(_[197], _[225]), bxor(_[198], _[226]), bxor(_[199], _[227]), bxor(_[200], _[228])
    _[233], _[234], _[235], _[236] = bxor(_[201], _[229]), bxor(_[202], _[230]), bxor(_[203], _[231]), bxor(_[204], _[232])
    _[237], _[238], _[239], _[240] = bxor(_[205], _[233]), bxor(_[206], _[234]), bxor(_[207], _[235]), bxor(_[208], _[236])
    return _
end

local function encrypt(datachunk, expandedkey)
    local _i = 1
    local __1, __2, __3, __4, __5, __6, __7, __8, __9, __10, __11, __12, __13, __14, __15, __16 = bxor(datachunk:sub(1,1):byte(), expandedkey[_i]), bxor(datachunk:sub(2,2):byte(), expandedkey[_i+1]), bxor(datachunk:sub(3,3):byte(), expandedkey[_i+2]), bxor(datachunk:sub(4,4):byte(), expandedkey[_i+3]), bxor(datachunk:sub(5,5):byte(), expandedkey[_i+4]),bxor(datachunk:sub(6,6):byte(), expandedkey[_i+5]), bxor(datachunk:sub(7,7):byte(), expandedkey[_i+6]), bxor(datachunk:sub(8,8):byte(), expandedkey[_i+7]), bxor(datachunk:sub(9,9):byte(), expandedkey[_i+8]), bxor(datachunk:sub(10,10):byte(), expandedkey[_i+9]), bxor(datachunk:sub(11,11):byte(), expandedkey[_i+10]),bxor(datachunk:sub(12,12):byte(), expandedkey[_i+11]), bxor(datachunk:sub(13,13):byte(), expandedkey[_i+12]), bxor(datachunk:sub(14,14):byte(), expandedkey[_i+13]), bxor(datachunk:sub(15,15):byte(), expandedkey[_i+14]), bxor(datachunk:sub(16,16):byte(), expandedkey[_i+15])
    for i = 1, 13 do
        _i = _i + 16
        __1, __2, __3, __4, __5, __6, __7, __8, __9, __10, __11, __12, __13, __14, __15, __16 = sbox[__1], sbox[__6], sbox[__11], sbox[__16], sbox[__5], sbox[__10], sbox[__15], sbox[__4], sbox[__9], sbox[__14], sbox[__3], sbox[__8], sbox[__13], sbox[__2], sbox[__7], sbox[__12]
        __1, __2, __3, __4, __5, __6, __7, __8, __9, __10, __11, __12, __13, __14, __15, __16 =bxor(bxor(bxor(bxor(gf(2, __1), gf(3, __2)), __3), __4), expandedkey[_i]), bxor(bxor(bxor(bxor(gf(2, __2), gf(3, __3)), __4), __1), expandedkey[_i+1]),bxor(bxor(bxor(bxor(gf(2, __3), gf(3, __4)), __1), __2), expandedkey[_i+2]), bxor(bxor(bxor(bxor(gf(2, __4), gf(3, __1)), __2), __3), expandedkey[_i+3]),bxor(bxor(bxor(bxor(gf(2, __5), gf(3, __6)), __7), __8), expandedkey[_i+4]), bxor(bxor(bxor(bxor(gf(2, __6), gf(3, __7)), __8), __5), expandedkey[_i+5]),bxor(bxor(bxor(bxor(gf(2, __7), gf(3, __8)), __5), __6), expandedkey[_i+6]), bxor(bxor(bxor(bxor(gf(2, __8), gf(3, __5)), __6), __7), expandedkey[_i+7]),bxor(bxor(bxor(bxor(gf(2, __9), gf(3, __10)), __11), __12), expandedkey[_i+8]), bxor(bxor(bxor(bxor(gf(2, __10), gf(3, __11)), __12), __9), expandedkey[_i+9]),bxor(bxor(bxor(bxor(gf(2, __11), gf(3, __12)), __9), __10), expandedkey[_i+10]), bxor(bxor(bxor(bxor(gf(2, __12), gf(3, __9)), __10), __11), expandedkey[_i+11]),bxor(bxor(bxor(bxor(gf(2, __13), gf(3, __14)), __15), __16), expandedkey[_i+12]), bxor(bxor(bxor(bxor(gf(2, __14), gf(3, __15)), __16), __13), expandedkey[_i+13]),bxor(bxor(bxor(bxor(gf(2, __15), gf(3, __16)), __13), __14), expandedkey[_i+14]), bxor(bxor(bxor(bxor(gf(2, __16), gf(3, __13)), __14), __15), expandedkey[_i+15])
    end
    _i = _i + 16
    return char(bxor(sbox[__1], expandedkey[_i])) .. char(bxor(sbox[__6], expandedkey[_i+1])) .. char(bxor(sbox[__11], expandedkey[_i+2])) ..char(bxor(sbox[__16], expandedkey[_i+3])) .. char(bxor(sbox[__5], expandedkey[_i+4])) .. char(bxor(sbox[__10], expandedkey[_i+5])) ..char(bxor(sbox[__15], expandedkey[_i+6])) .. char(bxor(sbox[__4], expandedkey[_i+7])) .. char(bxor(sbox[__9], expandedkey[_i+8])) ..char(bxor(sbox[__14], expandedkey[_i+9])) .. char(bxor(sbox[__3], expandedkey[_i+10])) .. char(bxor(sbox[__8], expandedkey[_i+11])) ..char(bxor(sbox[__13], expandedkey[_i+12])) .. char(bxor(sbox[__2], expandedkey[_i+13])) .. char(bxor(sbox[__7], expandedkey[_i+14])) .. char(bxor(sbox[__12], expandedkey[_i+15]))
end

local function decrypt(datachunk, expandedkey)
    local _i = 225
    local __1, __6, __11, __16, __5, __10, __15, __4, __9, __14, __3, __8, __13, __2, __7, __12 = invsbox[bxor(datachunk:sub(1,1):byte(), expandedkey[_i])], invsbox[bxor(datachunk:sub(2,2):byte(), expandedkey[_i+1])], invsbox[bxor(datachunk:sub(3,3):byte(), expandedkey[_i+2])], invsbox[bxor(datachunk:sub(4,4):byte(), expandedkey[_i+3])], invsbox[bxor(datachunk:sub(5,5):byte(), expandedkey[_i+4])], invsbox[bxor(datachunk:sub(6,6):byte(), expandedkey[_i+5])], invsbox[bxor(datachunk:sub(7,7):byte(), expandedkey[_i+6])], invsbox[bxor(datachunk:sub(8,8):byte(), expandedkey[_i+7])], invsbox[bxor(datachunk:sub(9,9):byte(), expandedkey[_i+8])], invsbox[bxor(datachunk:sub(10,10):byte(), expandedkey[_i+9])], invsbox[bxor(datachunk:sub(11,11):byte(), expandedkey[_i+10])], invsbox[bxor(datachunk:sub(12,12):byte(), expandedkey[_i+11])], invsbox[bxor(datachunk:sub(13,13):byte(), expandedkey[_i+12])], invsbox[bxor(datachunk:sub(14,14):byte(), expandedkey[_i+13])], invsbox[bxor(datachunk:sub(15,15):byte(), expandedkey[_i+14])], invsbox[bxor(datachunk:sub(16,16):byte(), expandedkey[_i+15])]
    for i = 1, 13 do
        _i = _i - 16
        __1, __2, __3, __4, __5, __6, __7, __8, __9, __10, __11, __12, __13, __14, __15, __16 = bxor(__1, expandedkey[_i]), bxor(__2, expandedkey[_i+1]), bxor(__3, expandedkey[_i+2]), bxor(__4, expandedkey[_i+3]), bxor(__5, expandedkey[_i+4]), bxor(__6, expandedkey[_i+5]), bxor(__7, expandedkey[_i+6]), bxor(__8, expandedkey[_i+7]), bxor(__9, expandedkey[_i+8]), bxor(__10, expandedkey[_i+9]), bxor(__11, expandedkey[_i+10]), bxor(__12, expandedkey[_i+11]), bxor(__13, expandedkey[_i+12]), bxor(__14, expandedkey[_i+13]), bxor(__15, expandedkey[_i+14]), bxor(__16, expandedkey[_i+15])
        __1, __6, __11, __16, __5, __10, __15, __4, __9, __14, __3, __8, __13, __2, __7, __12 = invsbox[bxor(bxor(bxor(gf(14, __1),  gf(11, __2)),  gf(13,__3)),  gf(9,__4))],invsbox[bxor(bxor(bxor(gf(9, __1),   gf(14, __2)),  gf(11,__3)),  gf(13,__4))],invsbox[bxor(bxor(bxor(gf(13, __1),  gf(9, __2)),   gf(14,__3)),  gf(11,__4))],invsbox[bxor(bxor(bxor(gf(11, __1),  gf(13, __2)),  gf(9,__3)),   gf(14,__4))],invsbox[bxor(bxor(bxor(gf(14, __5),  gf(11, __6)),  gf(13,__7)),  gf(9,__8))],invsbox[bxor(bxor(bxor(gf(9, __5),   gf(14, __6)),  gf(11,__7)),  gf(13,__8))],invsbox[bxor(bxor(bxor(gf(13, __5),  gf(9, __6)),   gf(14,__7)),  gf(11,__8))],invsbox[bxor(bxor(bxor(gf(11, __5),  gf(13, __6)),  gf(9,__7)),   gf(14,__8))],invsbox[bxor(bxor(bxor(gf(14, __9),  gf(11, __10)), gf(13,__11)), gf(9,__12))],invsbox[bxor(bxor(bxor(gf(9, __9),  gf(14, __10)), gf(11,__11)), gf(13,__12))],invsbox[bxor(bxor(bxor(gf(13, __9), gf(9, __10)),  gf(14,__11)),  gf(11,__12))],invsbox[bxor(bxor(bxor(gf(11, __9), gf(13, __10)),  gf(9,__11)),  gf(14,__12))],invsbox[bxor(bxor(bxor(gf(14, __13), gf(11, __14)), gf(13,__15)), gf(9,__16))],invsbox[bxor(bxor(bxor(gf(9, __13),  gf(14, __14)), gf(11,__15)), gf(13,__16))],invsbox[bxor(bxor(bxor(gf(13, __13), gf(9, __14)),  gf(14,__15)), gf(11,__16))],invsbox[bxor(bxor(bxor(gf(11, __13), gf(13, __14)), gf(9,__15)),  gf(14,__16))]
    end
    _i = _i - 16
    return char(bxor(__1, expandedkey[_i])) .. char(bxor(__2, expandedkey[_i+1])) .. char(bxor(__3, expandedkey[_i+2])) .. char(bxor(__4, expandedkey[_i+3])) ..char(bxor(__5, expandedkey[_i+4])) .. char(bxor(__6, expandedkey[_i+5])) .. char(bxor(__7, expandedkey[_i+6])) .. char(bxor(__8, expandedkey[_i+7])) ..char(bxor(__9, expandedkey[_i+8])) .. char(bxor(__10, expandedkey[_i+9])) .. char(bxor(__11, expandedkey[_i+10])) .. char(bxor(__12, expandedkey[_i+11])) ..char(bxor(__13, expandedkey[_i+12])) .. char(bxor(__14, expandedkey[_i+13])) .. char(bxor(__15, expandedkey[_i+14])) .. char(bxor(__16, expandedkey[_i+15]))
end

return{
    expandkey = expandkey,
    encrypt = encrypt,
    decrypt = decrypt
}
